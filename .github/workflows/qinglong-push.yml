# é’é¾™é¢æ¿å¾®ä¿¡æ¨é€è‡ªåŠ¨åŒ–å·¥ä½œæµ
# åŸºäºé’é¾™è„šæœ¬çš„å¾®ä¿¡å…¬ä¼—å·æ¨é€æœåŠ¡
name: qinglong-wechat-push

on:
  workflow_dispatch:
  schedule:
    # æ¯å¤©å›½é™…æ—¶é—´ 23:30 è¿è¡Œ, å³åŒ—äº¬æ—¶é—´ 7:30 è¿è¡Œ
    - cron: '30 23 * * *'

jobs:
  validate-and-push:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.x]

    steps:
    # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        ref: 'master'

    # æ­¥éª¤ 2: è®¾ç½® Node.js ç¯å¢ƒ
    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    # æ­¥éª¤ 3: ç¯å¢ƒå˜é‡éªŒè¯
    - name: éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
      run: |
        echo "ğŸ” å¼€å§‹éªŒè¯ç¯å¢ƒå˜é‡é…ç½®..."

        # æ£€æŸ¥ ALL_CONFIG æ˜¯å¦å­˜åœ¨
        if [ -z "${ALL_CONFIG}" ]; then
          echo "âŒ é”™è¯¯ï¼šALL_CONFIG ç¯å¢ƒå˜é‡æœªé…ç½®"
          echo "è¯·ç¡®ä¿åœ¨ GitHub Secrets ä¸­è®¾ç½®äº† ALL_CONFIG"
          exit 1
        fi

        echo "âœ… ALL_CONFIG ç¯å¢ƒå˜é‡å·²é…ç½®"

        # éªŒè¯ JSON æ ¼å¼
        echo "ğŸ” éªŒè¯ ALL_CONFIG JSON æ ¼å¼..."
        python3 -c "
        import json
        import sys
        try:
            config = json.loads('$ALL_CONFIG')
            print('âœ… ALL_CONFIG JSON æ ¼å¼æ­£ç¡®')

            # éªŒè¯å¿…éœ€çš„é…ç½®é¡¹
            if 'TEMPLATE_CONFIG' not in config:
                print('âŒ é”™è¯¯ï¼šTEMPLATE_CONFIG é…ç½®é¡¹ç¼ºå¤±')
                sys.exit(1)

            if not config['TEMPLATE_CONFIG'] or len(config['TEMPLATE_CONFIG']) == 0:
                print('âŒ é”™è¯¯ï¼šTEMPLATE_CONFIG ä¸èƒ½ä¸ºç©ºæ•°ç»„')
                sys.exit(1)

            print(f'âœ… å·²æ‰¾åˆ° {len(config[\"TEMPLATE_CONFIG\"])} ä¸ªæ¨¡æ¿é…ç½®')

            if 'USER_INFO' not in config:
                print('âŒ é”™è¯¯ï¼šUSER_INFO é…ç½®é¡¹ç¼ºå¤±')
                sys.exit(1)

            if not config['USER_INFO'] or len(config['USER_INFO']) == 0:
                print('âŒ é”™è¯¯ï¼šUSER_INFO ä¸èƒ½ä¸ºç©ºæ•°ç»„')
                sys.exit(1)

            print(f'âœ… å·²æ‰¾åˆ° {len(config[\"USER_INFO\"])} ä¸ªç”¨æˆ·é…ç½®')

            # éªŒè¯ç”¨æˆ·é…ç½®
            for i, user in enumerate(config['USER_INFO']):
                if 'useTemplateId' not in user:
                    print(f'âŒ é”™è¯¯ï¼šç”¨æˆ· {i+1} ç¼ºå°‘ useTemplateId é…ç½®')
                    sys.exit(1)

                # æ£€æŸ¥æ¨é€æ¸ é“é…ç½®
                has_wechat = 'id' in user and 'wechatTemplateId' in user
                has_pushdeer = 'pushDeerKey' in user

                if not has_wechat and not has_pushdeer:
                    print(f'âŒ é”™è¯¯ï¼šç”¨æˆ· {i+1} å¿…é¡»é…ç½®å¾®ä¿¡æµ‹è¯•å·æˆ– PushDeer æ¨é€æ¸ é“')
                    sys.exit(1)

            print('âœ… æ‰€æœ‰ç”¨æˆ·é…ç½®éªŒè¯é€šè¿‡')
            print('âœ… ç¯å¢ƒå˜é‡éªŒè¯å®Œæˆ')

        except json.JSONDecodeError as e:
            print(f'âŒ é”™è¯¯ï¼šALL_CONFIG JSON æ ¼å¼é”™è¯¯ - {e}')
            sys.exit(1)
        except Exception as e:
            print(f'âŒ é”™è¯¯ï¼šéªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ - {e}')
            sys.exit(1)
        "

    # æ­¥éª¤ 4: å®‰è£…é’é¾™è„šæœ¬ä¾èµ–
    - name: å®‰è£…é’é¾™è„šæœ¬ä¾èµ–
      working-directory: ./qinglong
      run: |
        echo "ğŸ“¦ æ­£åœ¨å®‰è£…é’é¾™è„šæœ¬ä¾èµ–..."
        npm install
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    # æ­¥éª¤ 5: è¿è¡Œé’é¾™æ¨é€è„šæœ¬
    - name: è¿è¡Œé’é¾™æ¨é€è„šæœ¬
      working-directory: ./qinglong
      run: |
        echo "ğŸš€ å¼€å§‹è¿è¡Œé’é¾™æ¨é€è„šæœ¬..."
        npm start
        echo "âœ… æ¨é€ä»»åŠ¡å®Œæˆ"
      env:
        ALL_CONFIG: ${{ secrets.ALL_CONFIG }}

    # æ­¥éª¤ 6: è¿è¡Œç»“æœé€šçŸ¥
    - name: è¿è¡Œç»“æœé€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… é’é¾™å¾®ä¿¡æ¨é€ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼"
          echo "ğŸ“± è¯·æ£€æŸ¥æ‚¨çš„å¾®ä¿¡æˆ– PushDeer è®¾å¤‡æ¥æ”¶æ¨é€æ¶ˆæ¯"
        else
          echo "âŒ é’é¾™å¾®ä¿¡æ¨é€ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
          echo "ğŸ” è¯·æ£€æŸ¥ï¼š"
          echo "   1. GitHub Secrets ä¸­çš„ ALL_CONFIG é…ç½®æ˜¯å¦æ­£ç¡®"
          echo "   2. æ¨¡æ¿é…ç½®å’Œç”¨æˆ·é…ç½®æ˜¯å¦å®Œæ•´"
          echo "   3. API å¯†é’¥å’Œç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
          echo "   4. æŸ¥çœ‹ä¸Šæ–¹è¯¦ç»†é”™è¯¯ä¿¡æ¯è¿›è¡Œæ’æŸ¥"
        fi

    # æ­¥éª¤ 7: ä¸Šä¼ æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
    - name: ä¸Šä¼ è¿è¡Œæ—¥å¿—
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: qinglong-push-logs
        path: |
          qinglong/*.log
          qinglong/logs/
        retention-days: 7